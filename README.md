# Data_Analysis_EX
Public Repository of the work I did on ENGIN-X during my placement year with ISIS.

Within each folder is an md file with a basic premise and a short tutorial on how to use the scripts inside. But for ease and comfort they're copied here too.

# Analysing Older Datasets

This folder contains work I did on analysing older datasets in order to obtain new information, primarily my work on Grain Size Analysis.

In Polycrystalline structures, grains of various sizes and orientations fit together almost like a jigsaw, with various orientations and sizes within. With the nature of neutron diffraction on ENGIN-X, it can often be hard to determine any useful information from the data, as all orientations are collected into two banks, north and south, and the data is summed together.

The detector banks are made up of 24 smaller detectors, extending to encompass an extra 10Â° either way, and feed data to 2400 pixels or spectra in the nexus datafile. Joe Kelleher proposed that if you were to seperate the summed spectrum into smaller groups, you could use this to analyse more closely the grains in the material.

This notebook is made up of three main functions.

PeakAcrossBanks detects and fits the peaks in the summed spectrum, then uses this to find and fit to the peaks in the separate spectra. This then retrieves the fitted parameters of each peak across each spectra then saves this all as a Panda Datafile.

<img width="1388" height="541" alt="PaB_351469" src="https://github.com/user-attachments/assets/bd49dd7e-b3e1-408f-a95d-4ecddd822472" />

AnalyseOrientationRelations takes this datafile then correlates each peak against each other to see which ones match the closest. The theory behind this is, the more the peaks correlate in the data, the more likely the two grains are twinning.

<img width="609" height="260" alt="358780" src="https://github.com/user-attachments/assets/37c23433-7d81-47ad-b898-c26bc631bde3" />

As shown here with this Copper dataset, there is quite a high correlation between the 111 and 200 peak (a value of 1.0 represents a perfect correlation in this case), implying the two grains may be close to twinning.

AnalyseGrainSize takes the intensities read for each peak from each detector and orders them, creating a graph of peak intensities irregardless of location. This intends to prove that the larger a grain is within a structure, the larger the range between the intensity values detected and vice versa. This can be represented on a graph with a line fit, where the gradient would be taken as an approximation of the range - a larger gradient meaning a larger grain etc.

<img width="640" height="480" alt="351464_GrainSize_graph" src="https://github.com/user-attachments/assets/1d3008ed-02a6-4972-a4e4-4d43a4f2807c" />

With the steepest gradient, it would be assumed in this case, that the 311 peak is the largest and the 331 is the smallest.

To use this notebook, first replace the paths in the first cell with the locations where you have saved the Summary Txt file, CIF folder, and Grouping Folder from the 'Misc' folder on this repository.

<img width="633" height="167" alt="loc_texts" src="https://github.com/user-attachments/assets/8ded877c-e66d-4e32-a177-a92cb2bc3ac5" />

You can search for the run of your experiment by user, title, or date using this cell.

<img width="1551" height="774" alt="search cell" src="https://github.com/user-attachments/assets/ef4c130b-fd43-4e8b-ae91-f037c4f64d4c" />

Or if you already know the run numbers, you can input the value into the called functions in the final cell here.

<img width="1433" height="132" alt="running_cell" src="https://github.com/user-attachments/assets/0a12e9ce-51ca-43fd-a4b0-d499afaf294d" />

This is also where you can select the grouping file if you wish to group the spectra differently. If you know the locations of the peaks in d-spacing, this can be added under peak_list and the correlation for Orientation Relations can be one of these six options:
- Pearson
- Spearman
- Kendall
- Regression
- Xi (requires newest version of Scipy)
- Weighted Kendall

This is an example of a typical output:
<img width="1550" height="741" alt="image" src="https://github.com/user-attachments/assets/75d87328-1810-4d47-af5e-dba4bd18bfdc" />

# Calibration Methods

This folder contains work I did improving and analysing two of the three Calibration Methods used on ENGIN-X: Pin Scan and Ceria Analysis.

The Ceria_var.txt should be generated by the Ceria Analysis notebook, but in case of adversity, the file can be downloaded from here too.

On ENGIN-X, we perform three main calibrations:
- A Vanadium run at the beginning of each cycle for the Incident Beam Spectrum
- A Ceria run every collimator change for the Peak Profiles
- And a Pin Scan every few days, often before an experiment, to locate the center of the Guage Volume

**Pin Scan**

For this calibration, we take a small steel pin about a millimetre wide and take neutron measurements as we move it incrementally across the X-axis (perpendicular to the beam). Taking a sum of the intensities from each run, we can figure out the point in which the most neutrons pass through the material, and hence, the centre of the guage volume. We then repeat the process with the Y-axis, providing graphs like this:

<img width="707" height="398" alt="image" src="https://github.com/user-attachments/assets/bf1b46c5-1c5f-4226-b31a-c8b7434f6bb5" />

To begin the process, you select the range of runs in which you performed the Pin Scan, then the axis and the bank in which the data was collected - either bank one or bank two.

<img width="241" height="129" alt="PinScan_choices" src="https://github.com/user-attachments/assets/0cd875f5-1fa7-44f4-bf45-a06e7a9c17a2" />

This script was initially written with Scipy, so if you would like to select that you can alongside the fit you would like to use. If you would like a more reliable fit, however, selecting the lmfit function chooses the most suitable one for you.

After the fit has been performed, the x0 value provides you with the location where the most neutrons were counted.

**Ceria**

Whenever we change the collimators or jaws on ENGIN-X, we perform a calibration measurement of Ceria powder for the peak profile, as we know the lattice parameters of that sample and thus can adjust the time of flight measurements accordingly. I wrote a script that searches the central servers for all instances of Ceria calibration on Engin-X, then sorts them by settings and collimator, before fitting peaks to each dataset in order to compare them over time. It takes the location, height, and width of each peak then stores them all in a json for later analysis.

# Multi-run Analysis

This folder contains the work I did writing code for multi-run analysis.

This has been the main bulk of my work, writing and debugging an algorithm to open, plot, fit peaks to, save, and store multiple runs when provided by a user.

This algorithm searches the internal servers for the nexus and raw file using just the run number, or finds said datafile in a filepath provided by the user. It then takes into account the experiment you wish to investigate, searching the file to find these parameters within. After doing so, it loads the file and converts the units to the d-space, extracting the x and y data. The fileSearch function can also extract data as far back as 2002, though certain features such as retrieving the parameters get worse as you go further back.

At the beginning, you provides the script with the runs you would like to analyse alongside the bank you would like to read data from - bank one, two, or both. The script then takes this, confirming whether or not the runs provided are intended to be a range or separate, before the fileSearch algorithm repeats the process on each run until all the data has been collected.

<img width="246" height="152" alt="choices_one" src="https://github.com/user-attachments/assets/413c327d-d22c-4b44-b8ae-6e96a5980920" />

You can also decide whether or not you would like to fit peaks to the dataset. The default peak fitting algorithm uses scipy find peaks to detect the peak location and lmfit to fit to the data. If the experiment was on a material with a cubic crystal structure, i.e. fcc or bcc, selecting that option will run a function which fits peaks to cubic datasets, much more accurately than the default function. If you already know the peak locations in the d-space, from literature or one of the Manual Peak Fit functions, then you can choose to provide this information to the script.

After this, you can select the experiment being performed in order to obtain the respective parameter for labels, and name the file and HDF the data will be stored in.

<img width="238" height="188" alt="choices_two" src="https://github.com/user-attachments/assets/6cb56ce8-5b2c-48f0-827e-8254d399db5b" />

You can decide whether or not you would like to see a plot of the data, and in that case, choose its name. If the data has a significant background the option to remove it from the raw data or add it to the fitted peaks is here as well.

<img width="248" height="222" alt="choices_three" src="https://github.com/user-attachments/assets/e2178010-d24a-4147-86f3-97d34ffcbf9c" />

Finally, if you would like to copy the raw data to your personal files this option is provided.

<img width="235" height="76" alt="choices_four" src="https://github.com/user-attachments/assets/30bf1a3b-3002-48e2-b78f-387596735b01" />

And if you would like to retrieve the data from your personal files instead of the internal servers, this option is available.

After this, the rest all works in the background to provide data and plots such as these:
<img width="640" height="480" alt="Local_Test_Plot" src="https://github.com/user-attachments/assets/47f4daab-9fa0-4a8d-85bf-f5bb68741d34" />
<img width="640" height="480" alt="Local_Test_Plot_HM" src="https://github.com/user-attachments/assets/ae446ec4-8b4b-40d0-8633-ff82c62519e3" />
<img width="640" height="480" alt="Al_for_Poster_Plot_Peaks" src="https://github.com/user-attachments/assets/dba418a1-5eee-47b9-bffc-cb72640d7ceb" />
<img width="640" height="480" alt="Al_for_Poster_nobg_dat_Plot_Peaks" src="https://github.com/user-attachments/assets/63778899-2f19-41dd-a6af-f7adfd715780" />
<img width="640" height="480" alt="Cu_for_Poster_Plot_Peaks" src="https://github.com/user-attachments/assets/86753929-7b6e-481f-92f3-0e60f37cb10c" />

